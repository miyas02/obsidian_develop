---

---
**セッションとデータベースを使う。**

以降のアクセスでは、ユーザがページを開くと、ブラウザは**セッションIDをWebサーバに送信する**。
ユーザがログイン済みかどうかは、セッションIDに紐づけられたセッション属性から顧客情報が取得できたかどうかで調べることができる。
取得出来たらログイン済み、取得できなかったら未ログインということ。

## ログイン機能の仕組み

### 顧客データの作成

ログイン名にuniqu制約を指定する。

```java
Customer.sql
drop table customer if exists;

create table customer (
	id int auto_increment primary key, 
	login varchar(100) not null unique, 
	password varchar(100) not null
);

insert into customer values(null, 'ayukawa', 'SweetfishRiver1');
insert into customer values(null, 'samejima', 'SharkIsland2');
insert into customer values(null, 'wanibuchi', 'CrocodileChasm3');
insert into customer values(null, 'ebihara', 'ShrimpField4');
insert into customer values(null, 'kanie', 'CrubBay5');
```

### 顧客情報を格納するBean

customerテーブルのid,login,passward列にあたるフィールドと、それらの内容を操作するためのセッタとゲッタを宣言する

```java
Customer.java
package bean;

public class Customer implements java.io.Serializable {

	private int id;
	private String login;
	private String password;

	public int getId() {
		return id;
	}
	public String getLogin() {
		return login;
	}
	public String getPassword() {
		return password;
	}
	
	public void setId(int id) {
		this.id=id;
	}
	public void setLogin(String login) {
		this.login=login;
	}
	public void setPassword(String password) {
		this.password=password;
	}
}
```

### CustomerDAOのプログラム

customerテーブルを操作するCustomerDAOを作成する

```java
CustomerDAO.java
package dao;

import bean.Customer;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;

public class CustomerDAO extends DAO { DAOクラスを継承
	public Customer search(String login, String password)
	CustomerDAOクラスでは、customerテーブルから顧客を検索するためのsearchメソッドのみを定義する
searchメソッドは、指定したログイン名とパスワードの顧客をcustomerテーブルから検索し、見つかった場合には顧客Bean(Customerオブジェクト)を返す。見つからなかったらnullを返す

		throws Exception {
		Customer customer=null;

		Connection con=getConnection();

		-----SQL文の実行-------
		PreparedStatement st;
		st=con.prepareStatement(
			"select * from customer where login=? and password=?"); ?には引数として渡されたログイン名とパスワードが入る
		st.setString(1, login);
		st.setString(2, password);
		ResultSet rs=st.executeQuery();
		------------------------

		-----検索結果を顧客Beanに保存する-----
		while (rs.next()) {
			customer=new Customer();
			customer.setId(rs.getInt("id"));
			customer.setLogin(rs.getString("login"));
			customer.setPassword(rs.getString("password"));
		}
		--------------------------------------

		st.close();
		con.close();
		return customer;
	}
}
```

## ログイン機能の作成

### JSPファイルの作成

次の３つのJSPファイルを作成する

- login-in.jsp ログイン名とパスワードを入力するJSPファイル
- login-out.jsp ログイン成功時のJSPファイル
- login-error.jsp ログイン失敗時のJSPファイル

```java
login-in.jsp
<%@page contentType="text/html; charset=UTF-8" %>
<%@include file="../header.html" %>

<form action="Login.action" method="post">
<from>タグのaction属性には、後で作成するログインアクションを指定する
<p>ログイン名<input type="text" name="login"></p>
<p>パスワード<input type="password" name="password"></p>
<p><input type="submit" value="ログイン"></p>
パスワードは、type属性をpasswordにすることで、非表示にする
</form>

<%@include file="../footer.html" %>

```

```java
login-out.jsp
<%@page contentType="text/html; charset=UTF-8" %>
<%@include file="../header.html" %>

こんにちは、${customer.login}さん。
セッション属性から顧客Beanを取得し、loginプロパティを出力している。これによりログイン名が表示される。

<%@include file="../footer.html" %>
```

```java
login-error.jsp
<%@page contentType="text/html; charset=UTF-8" %>
<%@include file="../header.html" %>

ログイン名またはパスワードが違います。

<%@include file="../footer.html" %>
```

### ログインアクションの作成

ログインの処理の手順

1. セッションを開始する
2. リクエストパラメータからログイン名とパスワードを取得する
3. 顧客テーブルから、指定されたログイン名とパスワードの顧客を検索する
4. 顧客が取得できたらログイン成功です。顧客Beanをセッションに設定し、ログイン成功ページにフォワードする。
5. 顧客が取得できなかったらログイン失敗です。ログイン失敗ページにフォワードする。

Actionクラスを継承して作成し、FrontControllerクラスを使って、JSPファイルにフォワードする。

```java
LoginAction.java
package chapter24;

import bean.Customer;
import dao.CustomerDAO;
import tool.Action;
import javax.servlet.http.*;

public class LoginAction extends Action {
	public String execute(
		HttpServletRequest request, HttpServletResponse response
	) throws Exception {

		HttpSession session=request.getSession();
		getSessionメソッドにより、セッションを開始する。

		String login=request.getParameter("login");
		String password=request.getParameter("password");
		リクエストパラメータからログイン名とパスワードを取得する

		CustomerDAO dao=new CustomerDAO();
		Customer customer=dao.search(login, password);
		CustomerDAOのsearchメソッドを使って、指定したログイン名とパスワードの顧客をデータベースから検索する
		
		if (customer!=null) {
			session.setAttribute("customer", customer);
			return "login-out.jsp";
		}
		ログイン成功時の処理。
		ログイン名とパスワードに合致する顧客が見つかった場合は、customerに見つかった顧客Beanが代入されているので、これをセッション属性に属性名customerで登録する。
		
		return "login-error.jsp";
		ログイン失敗時の処理
	}
}
```

## ログアウト処理

### JSPファイルの作成

次の３つのJSPファイルを作成する

- logout-in.jsp ログアウトのリンクを表示するjspファイル
- logout-out.jsp ログアウト成功時のjspファイル
- logout-error ログアウト失敗時のjspファイル

```java
loogout-in.jsp
<%@page contentType="text/html; charset=UTF-8" %>
<%@include file="../header.html" %>

<p>ログアウトしますか？</p>
<p><a href="Logout.action">ログアウト</a></p>
ログアウトを実行するリンク。リンク先はlogout.action
ログアウトを選択すると、ログアウトの処理を行うアクションが実行される

<%@include file="../footer.html" %>
```

```java
logout-out.jsp
<%@page contentType="text/html; charset=UTF-8" %>
<%@include file="../header.html" %>

ログアウトしました。

<%@include file="../footer.html" %>
```

```java
logout-error.jsp
<%@page contentType="text/html; charset=UTF-8" %>
<%@include file="../header.html" %>

すでにログアウトしています。

<%@include file="../footer.html" %>
```

### ログアウトアクションの作成

ログアウトの処理は次のような手順で行う

6. セッションを取得する
7. セッション属性として設定された顧客Beanを取得する
8. ログインしていれば、顧客Beanが取得できる。セッション属性から顧客Beanを削除した後に、ログアウト成功ページにフォワードする。
9. ログインしていない場合は、顧客Beanが取得できない。ログアウト失敗ページにフォワードする。

```java
LogoutAction.java
	package chapter24;

import tool.Action;
import javax.servlet.http.*;

public class LogoutAction extends Action {
	public String execute(
		HttpServletRequest request, HttpServletResponse response
	) throws Exception {

		HttpSession session=request.getSession();

		------ログインしている場合の処理-------
		if (session.getAttribute("customer")!=null) {
			session.removeAttribute("customer");
			return "logout-out.jsp";
		}
		----------------------------------------
		
		return "logout-error.jsp";
	}
}
```